import pandas as pd
import random
import string

# --- Нормативные значения освещенности ---
"""
Где:
    lux: норма освещения (в лм);
    norm: нормативный акт.
"""
LUX_RULES = {
    "Офис": {"lux": 500, "norm": "СП 52.13330.2016"},
    "Кафе": {"lux": 300, "norm": "СП 52.13330.2016"},
    "Обеденный зал (ресторан/столовая)": {"lux": 200, "norm": "СНиП 23-05-95"},
    "Цех (ресторан/столовая)": {"lux": 300, "norm": "СП 52.13330.2016"},
    "Склад": {"lux": 200, "norm": "СП 52.13330.2016"},
    "Школа (класс)": {"lux": 400, "norm": "СП 52.13330.2016"},
    "Больница (палата)": {"lux": 200, "norm": "СП 52.13330.2016"},
    "Жилое помещение": {"lux": 200, "norm": "СанПиН 2.2.1"},
    "Кухня": {"lux": 200, "norm": "СП 52.13330.2016"},
    "Санузел": {"lux": 50, "norm": "СП 52.13330.2016"},
    "Торговый зал": {"lux": 750, "norm": "СНиП 23-05-95"},
    "Улица": {"lux": 100, "norm": "СП 52.13330.2016"},
    "Аварийный выход": {"lux": 50, "norm": "ГОСТ Р 55710-2013"},
    "Коридор (общественный)": {"lux": 75, "norm": "СП 52.13330.2016"},
    "Коридор (жилой)": {"lux": 30, "norm": "СП 52.13330.2016"},
    "Лестничная клетка": {"lux": 35, "norm": "СП 52.13330.2016"},
    "Производственные (общее)": {"lux": 250, "norm": "СП 52.13330.2016"},
    "Производственные (точные работы)": {"lux": 450, "norm": "СП 52.13330.2016"},
    "Производственные (грубые работы)": {"lux": 180, "norm": "СП 52.13330.2016"},
    "Сцена театра": {"lux": 1000, "norm": "СНиП 23-05-95"},
    "Зал театра": {"lux": 200, "norm": "СНиП 23-05-95"},
    "Зал кинотеатра": {"lux": 50, "norm": "СНиП 23-05-95"},
    "Фойе театра/кинотеатра": {"lux": 150, "norm": "СП 52.13330.2016"},
    "Концертный зал": {"lux": 300, "norm": "СНиП 23-05-95"},
    "Конференц-зал": {"lux": 400, "norm": "СП 52.13330.2016"},
    "Выставочный зал": {"lux": 500, "norm": "СП 52.13330.2016"},
    "Спальня": {"lux": 150, "norm": "СП 52.13330.2016"},
    "Гостиная": {"lux": 200, "norm": "СП 52.13330.2016"},
    "Балкон/лоджия": {"lux": 100, "norm": "СП 52.13330.2016"},
    "Библиотека": {"lux": 300, "norm": "СП 52.13330.2016"},
    "Музейный зал": {"lux": 400, "norm": "СП 52.13330.2016"},
    "Цех деревообработки": {"lux": 300, "norm": "СП 52.13330.2016"},
    "Электромонтажный цех": {"lux": 400, "norm": "СП 52.13330.2016"},
    "Холодильный склад": {"lux": 150, "norm": "СП 52.13330.2016"},
    "Парковка": {"lux": 50, "norm": "СП 52.13330.2016"},
    "Сад/парк": {"lux": 30, "norm": "СП 52.13330.2016"},
    "Стадион": {"lux": 200, "norm": "СНиП 23-05-95"}
}

# --- Распределение площади по типам помещений (в м2)
AREA_RULES = {
    # Жилые
    "Спальня": (10, 25),
    "Гостиная": (15, 40),
    "Балкон/лоджия": (3, 10),
    "Жилое помещение": (12, 30),
    "Кухня": (8, 20),
    "Санузел": (2, 8),

    # Административные
    "Офис": (15, 80),
    "Кафе": (30, 150),
    "Обеденный зал (ресторан/столовая)": (50, 200),
    "Цех (ресторан/столовая)": (50, 150),
    "Школа (класс)": (30, 70),
    "Больница (палата)": (12, 30),
    "Библиотека": (50, 200),
    "Музейный зал": (100, 500),
    "Фойе театра/кинотеатра": (80, 200),
    "Зал театра": (200, 600),
    "Зал кинотеатра": (200, 500),
    "Сцена театра": (100, 300),
    "Концертный зал": (300, 1000),
    "Конференц-зал": (50, 200),
    "Выставочный зал": (200, 1000),

    # Промышленные
    "Склад": (100, 1000),
    "Производственные (общее)": (150, 1000),
    "Производственные (точные работы)": (100, 600),
    "Производственные (грубые работы)": (200, 1200),
    "Цех деревообработки": (150, 800),
    "Электромонтажный цех": (100, 400),
    "Холодильный склад": (80, 300),

    # Наружные
    "Улица": (50, 1000),
    "Аварийный выход": (5, 20),
    "Коридор (общественный)": (20, 100),
    "Коридор (жилой)": (5, 30),
    "Лестничная клетка": (10, 50),
    "Парковка": (200, 2000),
    "Сад/парк": (500, 5000),
    "Стадион": (2000, 20000)
}

# --- Группы брендов ---
BRAND_GROUPS = {
    "domestic": ["HomeLight", "EcoLight", "BrightLine", "ЭРА", "LumenPro", "Зенит"],           # Домашние
    "administrative": ["MaxLight", "OptiLight", "ПроСвет", "Юпитер", "ProLED", "ZetaLED"],     # Административные
    "industrial": ["LuxPro", "СветТех", "Феникс", "Philips", "Osram", "TechnoLight"],          # Промышленные
    "outdoor": ["StreetLine", "MarketLED", "Oculus", "SafeExit", "Плутон", "Андромеда"]        # Уличные
}

# --- Привязка типов помещений к группам брендов ---
ROOM_TO_BRAND = {
    # --- Домашние (domestic) ---
    "Жилое помещение": "domestic",
    "Кухня": "domestic",
    "Санузел": "domestic",
    "Коридор (жилой)": "domestic",
    "Спальня": "domestic",
    "Гостиная": "domestic",
    "Балкон/лоджия": "domestic",

    # --- Административные (administrative) ---
    "Офис": "administrative",
    "Кафе": "administrative",
    "Обеденный зал (ресторан/столовая)": "administrative",
    "Цех (ресторан/столовая)": "administrative",
    "Школа (класс)": "administrative",
    "Больница (палата)": "administrative",
    "Сцена театра": "administrative",
    "Зал театра": "administrative",
    "Зал кинотеатра": "administrative",
    "Фойе театра/кинотеатра": "administrative",
    "Концертный зал": "administrative",
    "Конференц-зал": "administrative",
    "Выставочный зал": "administrative",
    "Библиотека": "administrative",
    "Музейный зал": "administrative",

    # --- Промышленные (industrial) ---
    "Склад": "industrial",
    "Торговый зал": "industrial",
    "Производственные (общее)": "industrial",
    "Производственные (точные работы)": "industrial",
    "Производственные (грубые работы)": "industrial",
    "Цех деревообработки": "industrial",
    "Электромонтажный цех": "industrial",
    "Холодильный склад": "industrial",

    # --- Наружные (outdoor) ---
    "Улица": "outdoor",
    "Аварийный выход": "outdoor",
    "Коридор (общественный)": "outdoor",
    "Лестничная клетка": "outdoor",
    "Парковка": "outdoor",
    "Сад/парк": "outdoor",
    "Стадион": "outdoor"
}
# --- Привязка типов помещений к типам светильников ---
ROOM_TO_FIXTURES = {
    "Офис": ["Потолочный", "Подвесной", "Встраиваемый"],
    "Кафе": ["Подвесной", "Потолочный"],
    "Обеденный зал (ресторан/столовая)": ["Подвесной", "Потолочный"],
    "Цех (ресторан/столовая)": ["Промышленный (High-bay)", "Пылевлагозащищённый (IP65)"],
    "Школа (класс)": ["Потолочный", "Встраиваемый"],
    "Больница (палата)": ["Потолочный", "Настенный линейный"],
    "Жилое помещение": ["Потолочный", "Настенный (бра)"],
    "Кухня": ["Потолочный", "Встраиваемый"],
    "Санузел": ["Потолочный", "Пылевлагозащищённый (IP65)"],
    "Склад": ["Промышленный (High-bay)", "Прожектор"],
    "Торговый зал": ["Подвесной", "Встраиваемый"],
    "Производственные (общее)": ["Промышленный (High-bay)", "Взрывозащищённый"],
    "Производственные (точные работы)": ["Промышленный (High-bay)", "Встраиваемый"],
    "Производственные (грубые работы)": ["Прожектор", "Взрывозащищённый"],
    "Улица": ["Консольный", "Парковый фонарь"],
    "Аварийный выход": ["Аварийный", "Настенный линейный"],
    "Коридор (общественный)": ["Настенный линейный", "Аварийный"],
    "Коридор (жилой)": ["Настенный (бра)", "Настенный линейный"],
    "Лестничная клетка": ["Настенный линейный", "Аварийный"],
    "Сцена театра": ["Прожектор", "Подвесной", "Потолочный"],
    "Зал театра": ["Потолочный", "Настенный линейный"],
    "Зал кинотеатра": ["Настенный линейный", "Потолочный"],
    "Фойе театра/кинотеатра": ["Подвесной", "Потолочный"],
    "Концертный зал": ["Подвесной", "Прожектор"],
    "Конференц-зал": ["Подвесной", "Потолочный", "Встраиваемый"],
    "Выставочный зал": ["Прожектор", "Подвесной", "Встраиваемый"],
    "Спальня": ["Потолочный", "Настенный (бра)"],
    "Гостиная": ["Подвесной", "Потолочный"],
    "Балкон/лоджия": ["Настенный линейный", "Пылевлагозащищённый (IP65)"],
    "Библиотека": ["Подвесной", "Потолочный", "Настенный линейный"],
    "Музейный зал": ["Прожектор", "Подвесной", "Встраиваемый"],
    "Цех деревообработки": ["Промышленный (High-bay)", "Прожектор"],
    "Электромонтажный цех": ["Взрывозащищённый", "Пылевлагозащищённый (IP65)"],
    "Холодильный склад": ["Пылевлагозащищённый (IP65)", "Прожектор"],
    "Парковка": ["Консольный", "Прожектор"],
    "Сад/парк": ["Парковый фонарь", "Консольный"],
    "Стадион": ["Прожектор", "Консольный"]
}

# --- Разбивка светового потока по типам светильникв (в лм)
TYPICAL_LM = {
    "Потолочный": (2500, 3500),
    "Встраиваемый": (2000, 3500),
    "Подвесной": (3000, 4000),
    "Настенный (бра)": (500, 1000),
    "Настенный линейный": (1000, 2000),
    "Промышленный (High-bay)": (15000, 25000),
    "Прожектор": (10000, 20000),
    "Взрывозащищённый": (8000, 15000),
    "Пылевлагозащищённый (IP65)": (2500, 5000),
    "Консольный": (8000, 12000),
    "Парковый фонарь": (4000, 8000),
    "Аварийный": (150, 400)
}

# --- Страны производители ---
COUNTRIES = ["Россия", "Китай", "Италия", "Германия", "Турция", "Корея", "Тайвань", "США", "Франция"]

# --- Диапазоны высот потолков по сегментам ---
CEILING_RULES = {
    "domestic": (2.5, 3.0),          # жилые помещения (СНиП 31-01-2003)
    "administrative": (2.7, 13.0),   # офисы, школы, больницы, театры
    "industrial": (4.0, 12.0),       # склады, цеха, заводы
    "outdoor": (0.0, 0.0)            # улицы, парковки, стадионы (нет потолка)
}

# --- Установка цен на светильники
# --- Базовые коэффициенты цен по брендам ---
BRAND_PRICE_COEF = {
    "LuxPro": 1.3, "BrightLine": 1.1, "EcoLight": 0.9, "HomeLight": 1.0,
    "MarketLED": 1.0, "StreetLine": 1.1, "SafeExit": 1.2, "СветТех": 1.2,
    "ЭРА": 0.8, "Philips": 1.5, "Osram": 1.4, "Oculus": 1.1, "Феникс": 1.2,
    "LumenPro": 1.1, "Зенит": 1.0, "MaxLight": 1.2, "OptiLight": 1.1,
    "ПроСвет": 1.0, "Юпитер": 1.3, "ProLED": 1.1, "ZetaLED": 1.2,
    "TechnoLight": 1.3, "Плутон": 1.2, "Андромеда": 1.3
}

# --- Базовые коэффициенты цен для типов светильников ---
FIXTURE_COEFF = {
    "Потолочный": 1.0,
    "Встраиваемый": 1.2,
    "Подвесной": 1.3,
    "Настенный (бра)": 0.6,
    "Настенный линейный": 0.9,
    "Промышленный (High-bay)": 2.5,
    "Прожектор": 2.0,
    "Взрывозащищённый": 3.0,
    "Пылевлагозащищённый (IP65)": 1.8,
    "Консольный": 2.2,
    "Парковый фонарь": 1.7,
    "Аварийный": 0.5
}
# --- Генерация случайного имени модели светильника ---
def generate_suffixes(n=20000):
    letters = list(string.ascii_uppercase)
    suffixes = []
    counter = 1

    # Создаём комбинации вида AB123
    while len(suffixes) < n:
        prefix = "".join(random.choices(letters, k=2))   # две буквы
        number = str(counter).zfill(3)                   # трёхзначный номер
        suffixes.append(f"{prefix}{number}")
        counter += 1
    random.shuffle(suffixes)
    return suffixes

# --- Подготовка пула суффиксов ---
SUFFIX_POOL = generate_suffixes(20000)
SUFFIX_INDEX = 0

def random_model_name(room_type):
    global SUFFIX_INDEX
    group = ROOM_TO_BRAND.get(room_type, "domestic")
    brand = random.choice(BRAND_GROUPS[group])
    suffix = SUFFIX_POOL[SUFFIX_INDEX]
    SUFFIX_INDEX += 1

    return f"{brand} {suffix}"

# --- Генерация одной строки ---
def generate_row(room_type):
    norm_data = LUX_RULES[room_type]
    low, high = AREA_RULES.get(room_type, (10, 200))
    area = random.randint(low, high)

    # Определяем сегмент по словарю ROOM_TO_BRAND
    segment = ROOM_TO_BRAND[room_type]
    low, high = CEILING_RULES[segment]
    ceiling = round(random.uniform(low, high), 1) if low != high else 0.0

    required_lux = int(norm_data["lux"] * random.uniform(0.9, 1.1))

    # Поправка на высоту потолка (выше 3 м → больше люменов)
    height_factor = 1 + 0.05 * max(0, ceiling - 3)
    total_lumens = int(required_lux * area * height_factor)

    # Сначала выбираем тип и люмены светильника
    fixture_type = random.choice(ROOM_TO_FIXTURES[room_type])
    fixture_lm_range = TYPICAL_LM.get(fixture_type, (2500, 3500))
    fixture_lm = random.randint(*fixture_lm_range)
    fixtures_count = max(1, total_lumens // fixture_lm)

    # Генерация имени и бренда
    model_name = random_model_name(room_type)
    brand = model_name.split()[0]

    # --- Цена = люмены × базовая ставка × коэффициенты ---
    base_rate = 0.5  # руб/лм
    price_rub = int(
        fixture_lm
        * base_rate
        * BRAND_PRICE_COEF.get(brand, 1.0)
        * FIXTURE_COEFF.get(fixture_type, 1.0)
    )

    # --- Бюджет = стоимость всех светильников × коэффициент ---
    budget = int(fixtures_count * price_rub * random.uniform(1.0, 1.5))

    country = random.choice(COUNTRIES)

    return {
        "room_type": room_type,
        "segment": segment,
        "area_m2": area,
        "ceiling_h": ceiling,
        "budget": budget,
        "required_lux": required_lux,
        "total_lumens": total_lumens,
        "fixtures_count": int(fixtures_count),
        "fixture_type": fixture_type,
        "fixture_lm": fixture_lm,
        "purpose": room_type,
        "country": country,
        "model_name": model_name,
        "price_rub": price_rub,
        "norm_ref": norm_data["norm"]
    }

# --- Генерация датасета ---
def generate_dataset(n_rows=20000):
    rows = []
    room_types = list(LUX_RULES.keys())
    for _ in range(n_rows):
        room = random.choice(room_types)
        rows.append(generate_row(room))
    return pd.DataFrame(rows)

if __name__ == "__main__":
    df = generate_dataset(20000)
    df.to_csv("data/lighting_dataset.csv", index=False, encoding="utf-8-sig")
    print("Датасет сохранён: data/lighting_dataset.csv")
    print(df.head())